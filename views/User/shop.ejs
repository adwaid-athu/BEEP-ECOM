<%- include('../partials/user/header.ejs') %>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<main class="main pt-5 mt-5">
    <nav aria-label="breadcrumb" class="breadcrumb-nav mb-2">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="#">Shop</a></li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->

    <div class="page-content">
        <div class="container">
            <div class="row">
                <!-- Filter Section (Left Column) -->
                <div class="col-lg-3">
                    <form method="GET" action="/shop">
                        <!-- Category Filter -->
                        <h3>Categories</h3>
                        <% categories.forEach(category => { %>
                            <div>
                                <input type="checkbox" name="categories" value="<%= category._id %>" 
                                    id="category-<%= category._id %>"
                                    <%= selectedCategories && selectedCategories.includes(category._id.toString()) ? 'checked' : '' %> >
                                <label for="category-<%= category._id %>"><%= category.name %></label>
                            </div>
                        <% }); %>

                        <!-- Brand Filter -->
                        <h3>Brands</h3>
                        <% brands.forEach(brand => { %>
                            <div>
                                <input type="checkbox" name="brands" value="<%= brand._id %>" 
                                    id="brand-<%= brand._id %>"
                                    <%= selectedBrands && selectedBrands.includes(brand._id.toString()) ? 'checked' : '' %> >
                                <label for="brand-<%= brand._id %>"><%= brand.brandName %></label>
                            </div>
                        <% }); %>

                        <!-- Price Filter -->
                        <h3>Price Range</h3>
                        <label for="minPrice">Min Price:</label>
                        <input type="number" name="minPrice" id="minPrice" value="<%= priceMin %>" placeholder="0">

                        <label for="maxPrice">Max Price:</label>
                        <input type="number" name="maxPrice" id="maxPrice" value="<%= priceMax %>" placeholder="1000">

                        <!-- Sort Options -->
                        <h3>Sort By</h3>
                        <select name="sortby">
                            <option value="">Select...</option>
                            <option value="a-z" <%= sort === "a-z" ? 'selected' : '' %>>A-Z</option>
                            <option value="z-a" <%= sort === "z-a" ? 'selected' : '' %>>Z-A</option>
                            <option value="low-to-high" <%= sort === "low-to-high" ? 'selected' : '' %>>Price: Low to High</option>
                            <option value="high-to-low" <%= sort === "high-to-low" ? 'selected' : '' %>>Price: High to Low</option>
                            <option value="new-arrivals" <%= sort === "new-arrivals" ? 'selected' : '' %>>New Arrivals</option>
                            <option value="old-arrivals" <%= sort === "old-arrivals" ? 'selected' : '' %>>Old Arrivals</option>
                        </select>

                        <button type="submit">Apply Filters</button>
                    </form>
                </div><!-- End .col-lg-3 -->

                <!-- Products Section (Right Column) -->
                <div class="col-lg-9">
                    <div class="toolbox">
                        <div class="toolbox-left">
                            <!-- You can add any additional toolbox elements here -->
                        </div><!-- End .toolbox-left -->
                    </div><!-- End .toolbox -->

                    <div class="products mb-3">
                        <div class="row ">
                            <% products.forEach(product => { %>
                                <% if (!product.isBlocked && product.status === "Available") { %>
                                <div class="col-6 col-md-4 col-lg-4">
                                    <div class="product product-7 text-center">
                                        <figure class="product-media">
                                            <a href="/product?productId=<%= product._id %>">
                                                <img src="upload/product-images/<%= product.productImage[0] %>" alt="<%= product.productName %> image" class="product-image">
                                            </a>

                                            <div class="product-action-vertical">
                                                <a onclick="addToWishlist(`<%=product._id%>`)" class="btn-product-icon btn-wishlist btn-expandable"><span>Add to Wishlist</span></a>
                                            </div><!-- End .product-action-vertical -->

                                            <div class="product-action">
                                                <a href="javascript:void(0)" onclick="addToCart(`<%=product._id%>`)" class="btn-product btn-cart"><span>Add to Cart</span></a>
                                            </div><!-- End .product-action -->
                                        </figure><!-- End .product-media -->

                                        <div class="product-body">
                                            <div class="product-cat">
                                                <a href="/category/<%= product.category._id %>"><%= product.category.name %></a>
                                            </div><!-- End .product-cat -->
                                            <h3 class="product-title"><a href="/product?productId=<%= product._id %>"><%= product.productName %></a></h3>
                                            <div class="product-price">
                                                <% if (product.status === "Available") { %>
                                                  <div class="old-price mr-3">₹<%= product.regularPrice %></div>
                                                  <%
                                                    let discount = false;
                                                    if (product.offer && product.offer.discount) {
                                                      discount = product.offer.discount;
                                                    } else if (product.category && product.category.offer && product.category.offer.discount) {
                                                      discount = product.category.offer.discount;
                                                    } else if (product.brand && product.brand.offer && product.brand.offer.discount) {
                                                      discount = product.brand.offer.discount;
                                                    }
                                                    discount = parseFloat(discount) || 0; // Ensure discount is a valid number
                                                  %>
                                                  <% if (discount > 0) { %> 
                                                    ₹<%= (product.salePrice - (product.salePrice * (discount / 100))).toFixed(2) %>
                                                  <% } else { %> 
                                                    ₹<%= product.salePrice %>
                                                  <% } %>
                                                <% } else { %>
                                                  <%= product.status %>
                                                <% } %>
                                              </div>
                                        </div><!-- End .product-body -->
                                    </div><!-- End .product -->
                                </div><!-- End .col-6 col-md-4 col-lg-4 -->
                                <% } %>
                            <% }); %>
                        </div><!-- End .row -->
                    </div><!-- End .products -->

                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            <% if (currentPage > 1) { %>
                                <li class="page-item">
                                    <a class="page-link page-link-prev" href="/shop?page=<%= currentPage - 1 %>" aria-label="Previous">
                                        <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span> Prev
                                    </a>
                                </li>
                            <% } else { %>
                                <li class="page-item disabled">
                                    <a class="page-link page-link-prev" href="#" aria-label="Previous" tabindex="-1" aria-disabled="true">
                                        <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span> Prev
                                    </a>
                                </li>
                            <% } %>

                            <% for (let i = 1; i <= totalPages; i++) { %>
                                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                    <a class="page-link" href="/shop?page=<%= i %>"><%= i %></a>
                                </li>
                            <% } %>

                            <li class="page-item-total">of <%= totalPages %></li>

                            <% if (currentPage < totalPages) { %>
                                <li class="page-item">
                                    <a class="page-link page-link-next" href="/shop?page=<%= currentPage + 1 %>" aria-label="Next">
                                        Next <span aria-hidden="true"><i class="icon-long-arrow-right"></i></span>
                                    </a>
                                </li>
                            <% } else { %>
                                <li class="page-item disabled">
                                    <a class="page-link page-link-next" href="#" aria-label="Next" tabindex="-1" aria-disabled="true">
                                        Next <span aria-hidden="true"><i class="icon-long-arrow-right"></i></span>
                                    </a>
                                </li>
                            <% } %>
                        </ul>
                    </nav><!-- End .pagination -->
                </div><!-- End .col-lg-9 -->
            </div><!-- End .row -->
        </div><!-- End .container -->
    </div><!-- End .page-content -->
</main><!-- End .main -->

<%- include('../partials/user/footer.ejs') %>
<script>
	function addToCart(productId) {
    try {
      fetch(`/addToCart/${productId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            Swal.fire({
              title: "Added to Cart!",
              text: data.message || "The product was added to your cart.",
              icon: "success",
              timer: 1500,
            });
          } else {
            Swal.fire({
              title: "Error",
              text:
                data.message ||
                "Could not add the product to your cart.",
              icon: "error",
              confirmButtonText: "OK",
            });
          }
        });
    } catch (error) {
      console.error("Error adding to cart:", error);
      Swal.fire({
        title: "Error",
        text: "Something went wrong while adding to cart.",
        icon: "error",
        confirmButtonText: "OK",
      });
    }
  }

  function addToWishlist(productId) {
  try {
    fetch(`/addToWishlist/${productId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({}),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          Swal.fire({
            title: "Added to Wishlist!",
            text: data.message || "The product was added to your wishlist.",
            icon: "success",
            timer: 1500,
          });
        } else {
          Swal.fire({
            title: "Error",
            text: data.message || "Could not add the product to your wishlist.",
            icon: "error",
            confirmButtonText: "OK",
          });
        }
      });
  } catch (error) {
    console.error("Error adding to wishlist:", error);
    Swal.fire({
      title: "Error",
      text: "Something went wrong while adding to wishlist.",
      icon: "error",
      confirmButtonText: "OK",
    });
  }
}
</script>